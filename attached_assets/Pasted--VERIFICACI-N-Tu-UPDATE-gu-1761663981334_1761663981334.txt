-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ” VERIFICACIÃ“N: Â¿Tu UPDATE guarda el refresh token?
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Este es el UPDATE CORRECTO que debes tener en tu workflow:

UPDATE ghl_clientes 
SET 
  accesstoken = '{{ $json.accesstoken }}',        -- âœ… Access token nuevo
  refreshtoken = '{{ $json.refreshtoken }}',      -- â­ CRÃTICO: Refresh token nuevo
  refreshtokenid = '{{ $json.refreshtokenid }}',  -- âœ… ID del refresh token
  expiresat = {{ $json.expiresat }},              -- âœ… Nueva fecha expiraciÃ³n
  lastrefreshed = CURRENT_TIMESTAMP               -- âœ… Timestamp actualizaciÃ³n
WHERE id = {{ $json.cliente_id }}
RETURNING 
  id, 
  nombre_cliente, 
  to_timestamp(expiresat) as nueva_expiracion,
  lastrefreshed,
  LEFT(refreshtoken, 50) || '...' as refresh_preview;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- âŒ UPDATE INCORRECTO (falta refreshtoken):
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- UPDATE ghl_clientes 
-- SET 
--   accesstoken = '{{ $json.accesstoken }}',
--   expiresat = {{ $json.expiresat }},
--   lastrefreshed = CURRENT_TIMESTAMP
--   -- âŒ FALTA: refreshtoken = '{{ $json.refreshtoken }}'
-- WHERE id = {{ $json.cliente_id }};

-- Resultado: Access token actualizado pero refresh token NO
-- PrÃ³xima ejecuciÃ³n: "invalid_grant"

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ” VERIFICAR ANTES/DESPUÃ‰S DEL WORKFLOW
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- EJECUTAR ANTES del workflow:
SELECT 
  id,
  nombre_cliente,
  MD5(refreshtoken) as hash_refresh_antes,
  MD5(accesstoken) as hash_access_antes,
  to_timestamp(expiresat) as expira_antes,
  lastrefreshed as actualizado_antes
FROM ghl_clientes
WHERE isactive = true
ORDER BY id;

-- EJECUTAR DESPUÃ‰S del workflow:
SELECT 
  id,
  nombre_cliente,
  MD5(refreshtoken) as hash_refresh_despues,
  MD5(accesstoken) as hash_access_despues,
  to_timestamp(expiresat) as expira_despues,
  lastrefreshed as actualizado_despues,
  CASE 
    WHEN EXTRACT(EPOCH FROM (NOW() - lastrefreshed)) < 60 THEN 'âœ… Actualizado'
    ELSE 'âŒ No actualizado'
  END as estado
FROM ghl_clientes
WHERE isactive = true
ORDER BY id;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- âœ… VERIFICACIÃ“N: Â¿CambiÃ³ el refresh token?
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Comparar los hash:
-- hash_refresh_antes â‰  hash_refresh_despues â†’ âœ… Refresh token SÃ cambiÃ³
-- hash_refresh_antes = hash_refresh_despues â†’ âŒ Refresh token NO cambiÃ³ (PROBLEMA)